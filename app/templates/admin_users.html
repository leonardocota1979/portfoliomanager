{% extends "base.html" %}

{% block nav_links %}
<div class="flex items-center gap-4 text-sm text-slate-200">
  <a href="/" class="hover:text-white transition">Home</a>
  <a href="/admin/users" class="hover:text-white transition">Admin</a>
</div>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Administra√ß√£o de Usu√°rios</h1>
      <p class="text-sm text-gray-500">Crie, edite, redefina senha e remova usu√°rios</p>
    </div>
    <button onclick="openCreateModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
      ‚ûï Novo Usu√°rio
    </button>
  </div>

  <div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="p-4 border-b text-sm text-gray-500 flex items-center justify-between gap-4">
      <div>Total: {{ total }}</div>
      <form class="flex gap-2 items-center" method="get" action="/admin/users">
        <input type="text" name="q" value="{{ q }}" placeholder="Buscar usu√°rio ou email"
               class="px-3 py-2 border rounded text-sm w-64">
        <input type="hidden" name="limit" value="{{ limit }}">
        <button class="bg-green-50 text-green-700 border border-green-200 px-3 py-2 rounded hover:bg-green-100 text-sm">
          Buscar
        </button>
      </form>
    </div>
    <table class="w-full text-sm">
      <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
        <tr>
          <th class="py-2 px-3 text-left">Usu√°rio</th>
          <th class="py-2 px-3 text-left">Email</th>
          <th class="py-2 px-3 text-center">Admin</th>
          <th class="py-2 px-3 text-right">Criado em</th>
          <th class="py-2 px-3 text-center">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr class="border-t">
          <td class="py-2 px-3 font-medium">{{ u.username }}</td>
          <td class="py-2 px-3">{{ u.email or '-' }}</td>
          <td class="py-2 px-3 text-center">
            {% if u.is_admin %}‚úÖ{% else %}-{% endif %}
          </td>
          <td class="py-2 px-3 text-right">{{ u.created_at.strftime('%d/%m/%Y') }}</td>
          <td class="py-2 px-3 text-center space-x-2">
            <button onclick="openEditModal({{ u.id }}, '{{ u.username }}', '{{ u.email or '' }}', {{ 'true' if u.is_admin else 'false' }})"
                    class="bg-green-50 text-green-700 border border-green-200 px-3 py-1 rounded hover:bg-green-100">
              ‚úèÔ∏è Editar
            </button>
            <button onclick="openResetModal({{ u.id }}, '{{ u.username }}')"
                    class="bg-green-50 text-green-700 border border-green-200 px-3 py-1 rounded hover:bg-green-100">
              üîë Resetar
            </button>
            {% if current_user and current_user.id == u.id %}
            <span class="text-xs text-gray-400">‚Äî</span>
            {% else %}
            <button onclick="confirmDelete({{ u.id }}, '{{ u.username }}')"
                    class="bg-green-50 text-green-700 border border-green-200 px-3 py-1 rounded hover:bg-green-100">
              üóëÔ∏è Remover
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="p-4 border-t flex items-center justify-between text-sm text-gray-600">
      <div>P√°gina {{ page }} de {{ total_pages }}</div>
      <div class="flex gap-2">
        {% if page > 1 %}
        <a href="/admin/users?q={{ q }}&page={{ page - 1 }}&limit={{ limit }}"
           class="bg-green-50 text-green-700 border border-green-200 px-3 py-1 rounded hover:bg-green-100">Anterior</a>
        {% endif %}
        {% if page < total_pages %}
        <a href="/admin/users?q={{ q }}&page={{ page + 1 }}&limit={{ limit }}"
           class="bg-green-50 text-green-700 border border-green-200 px-3 py-1 rounded hover:bg-green-100">Pr√≥xima</a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal: Criar Usu√°rio -->
<div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target===this)closeModal('createModal')">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">‚ûï Novo Usu√°rio</h2>
      <button onclick="closeModal('createModal')" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
    </div>
    <form id="createForm" class="space-y-3">
      <div>
        <label class="block text-sm font-medium mb-1">Username *</label>
        <input type="text" id="create_username" class="w-full px-3 py-2 border rounded" required>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Email *</label>
        <input type="email" id="create_email" class="w-full px-3 py-2 border rounded" required>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Senha *</label>
        <input type="password" id="create_password" class="w-full px-3 py-2 border rounded" required>
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="create_is_admin">
        <label class="text-sm">Administrador</label>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Criar</button>
        <button type="button" onclick="closeModal('createModal')" class="flex-1 bg-green-50 text-green-700 border border-green-200 px-4 py-2 rounded hover:bg-green-100">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Editar Usu√°rio -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target===this)closeModal('editModal')">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">‚úèÔ∏è Editar Usu√°rio</h2>
      <button onclick="closeModal('editModal')" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
    </div>
    <form id="editForm" class="space-y-3">
      <input type="hidden" id="edit_id">
      <div>
        <label class="block text-sm font-medium mb-1">Username</label>
        <input type="text" id="edit_username" class="w-full px-3 py-2 border rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Email</label>
        <input type="email" id="edit_email" class="w-full px-3 py-2 border rounded">
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="edit_is_admin">
        <label class="text-sm">Administrador</label>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Salvar</button>
        <button type="button" onclick="closeModal('editModal')" class="flex-1 bg-green-50 text-green-700 border border-green-200 px-4 py-2 rounded hover:bg-green-100">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Resetar Senha -->
<div id="resetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target===this)closeModal('resetModal')">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">üîë Resetar Senha</h2>
      <button onclick="closeModal('resetModal')" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
    </div>
    <form id="resetForm" class="space-y-3">
      <input type="hidden" id="reset_id">
      <div class="text-sm text-gray-600" id="reset_user_label"></div>
      <div>
        <label class="block text-sm font-medium mb-1">Nova senha *</label>
        <input type="password" id="reset_password" class="w-full px-3 py-2 border rounded" required>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Salvar</button>
        <button type="button" onclick="closeModal('resetModal')" class="flex-1 bg-green-50 text-green-700 border border-green-200 px-4 py-2 rounded hover:bg-green-100">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
function openCreateModal() {
  document.getElementById('createForm').reset();
  document.getElementById('createModal').classList.remove('hidden');
}
function openEditModal(id, username, email, isAdmin) {
  document.getElementById('edit_id').value = id;
  document.getElementById('edit_username').value = username;
  document.getElementById('edit_email').value = email || '';
  document.getElementById('edit_is_admin').checked = !!isAdmin;
  document.getElementById('editModal').classList.remove('hidden');
}
function openResetModal(id, username) {
  document.getElementById('reset_id').value = id;
  document.getElementById('reset_user_label').textContent = `Usu√°rio: ${username}`;
  document.getElementById('reset_password').value = '';
  document.getElementById('resetModal').classList.remove('hidden');
}
function closeModal(id) {
  document.getElementById(id).classList.add('hidden');
}

document.getElementById('createForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    username: document.getElementById('create_username').value.trim(),
    email: document.getElementById('create_email').value.trim(),
    password: document.getElementById('create_password').value,
    is_admin: document.getElementById('create_is_admin').checked
  };
  try {
    const resp = await fetch('/users/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error((await resp.json()).detail || 'Erro');
    window.location.reload();
  } catch (e) {
    alert('Erro: ' + e.message);
  }
});

document.getElementById('editForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('edit_id').value;
  const payload = {
    username: document.getElementById('edit_username').value.trim(),
    email: document.getElementById('edit_email').value.trim(),
    is_admin: document.getElementById('edit_is_admin').checked
  };
  try {
    const resp = await fetch(`/users/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error((await resp.json()).detail || 'Erro');
    window.location.reload();
  } catch (e) {
    alert('Erro: ' + e.message);
  }
});

document.getElementById('resetForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('reset_id').value;
  const payload = {
    password: document.getElementById('reset_password').value
  };
  try {
    const resp = await fetch(`/users/${id}/reset-password`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error((await resp.json()).detail || 'Erro');
    window.location.reload();
  } catch (e) {
    alert('Erro: ' + e.message);
  }
});

async function confirmDelete(id, username) {
  if (!confirm(`Remover usu√°rio "${username}"?`)) return;
  try {
    const resp = await fetch(`/users/${id}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error((await resp.json()).detail || 'Erro');
    window.location.reload();
  } catch (e) {
    alert('Erro: ' + e.message);
  }
}
</script>
{% endblock %}
