{% extends "base.html" %}

{% block nav_links %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Configurar Portfolio</h1>

    <!-- PASSO 1: Info B√°sica -->
    <div id="step1" class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4">üìã Passo 1: Informa√ß√µes B√°sicas</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Carteira *</label>
                <input type="text" id="portfolio_name" required
                       class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                       placeholder="Ex: Minha Carteira Global">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                <textarea id="portfolio_description" rows="3"
                          class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                          placeholder="Estrat√©gia e objetivos..."></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor Total *</label>
                    <input type="number" id="total_value" required step="0.01" min="0"
                           class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                           placeholder="1000000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Moeda *</label>
                    <select id="currency" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                        <option value="USD">USD - D√≥lar Americano</option>
                        <option value="BRL">BRL - Real Brasileiro</option>
                        <option value="EUR">EUR - Euro</option>
                    </select>
                </div>
            </div>
        </div>

        <button onclick="goToStep2()" class="mt-6 bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700">
            Pr√≥ximo: Selecionar Classes ‚Üí
        </button>
    </div>

    <!-- PASSO 2: Selecionar Classes -->
    <div id="step2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">üéØ Passo 2: Selecionar Classes de Ativos</h2>

        <div class="border rounded-lg p-4 mb-4 bg-gray-50">
            <p class="text-sm text-gray-700 mb-3">
                Voc√™ pode usar classes padr√£o e tamb√©m criar classes personalizadas.
            </p>
            <div class="flex gap-2">
                <input type="text" id="custom_class_name"
                       class="flex-1 px-3 py-2 border rounded-md"
                       placeholder="Nova classe personalizada (ex.: Reserva T√°tica)">
                <button onclick="addCustomClass()"
                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                    + Adicionar classe
                </button>
            </div>
            <p id="classes_error" class="text-sm text-red-600 mt-2 hidden"></p>
        </div>
        
        <div id="classes_list" class="space-y-3 mb-6">
            <!-- Ser√° preenchido via JavaScript -->
        </div>

        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
            <p class="text-sm text-yellow-700">
                ‚ö†Ô∏è A soma dos percentuais deve ser <strong>100%</strong>
            </p>
            <p class="text-2xl font-bold mt-2" id="total_percentage">Total: 0%</p>
        </div>

        <div class="flex gap-4">
            <button onclick="goToStep1()" class="bg-green-50 text-green-700 border border-green-200 px-6 py-3 rounded-md hover:bg-green-100">
                ‚Üê Voltar
            </button>
            <button onclick="createPortfolio()" id="create_btn" disabled
                    class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                Criar Portfolio ‚úì
            </button>
        </div>
    </div>
</div>

<script>
let globalClasses = [];
let selectedClasses = [];

function classKeyFromName(name) {
    return String(name || '')
        .trim()
        .toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
}

function showClassesError(message) {
    const el = document.getElementById('classes_error');
    if (!message) {
        el.textContent = '';
        el.classList.add('hidden');
        return;
    }
    el.textContent = message;
    el.classList.remove('hidden');
}

function buildSelectedClassesFromGlobal() {
    selectedClasses = globalClasses.map(cls => ({
        key: `g_${cls.id}`,
        id: cls.id,
        name: cls.name,
        description: cls.description || '',
        isCustom: false,
        selected: false,
        percentage: 0
    }));
}

// Carrega classes globais
async function loadGlobalClasses() {
    showClassesError('');
    try {
        const response = await fetch('/asset-classes/global-classes');
        if (!response.ok) {
            throw new Error(`Falha ao carregar classes padr√£o (${response.status})`);
        }
        globalClasses = await response.json();
        buildSelectedClassesFromGlobal();
        renderClassesStep2();
    } catch (error) {
        selectedClasses = [];
        renderClassesStep2();
        showClassesError('N√£o foi poss√≠vel carregar classes padr√£o. Verifique login/permiss√£o e tente novamente.');
    }
}

async function goToStep2() {
    const name = document.getElementById('portfolio_name').value;
    const value = document.getElementById('total_value').value;
    
    if (!name || !value || value <= 0) {
        alert('Preencha nome e valor total!');
        return;
    }
    
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    await loadGlobalClasses();
}

function goToStep1() {
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
}

function renderClassesStep2() {
    const container = document.getElementById('classes_list');
    if (selectedClasses.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">Nenhuma classe dispon√≠vel no momento.</p>';
        updateTotal();
        return;
    }

    container.innerHTML = selectedClasses.map(cls => `
        <div class="border rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="class_${cls.key}" 
                           ${cls.selected ? 'checked' : ''}
                           onchange="toggleClass('${cls.key}')"
                           class="w-5 h-5">
                    <label for="class_${cls.key}" class="font-medium">${cls.name}</label>
                    <span class="text-sm text-gray-500">${cls.description || ''}</span>
                    ${cls.isCustom ? '<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">Personalizada</span>' : ''}
                </div>
                <div class="flex items-center gap-2" id="input_${cls.key}" style="display:${cls.selected ? 'flex' : 'none'};">
                    <input type="number" id="percent_${cls.key}" 
                           min="0" max="100" step="0.1" placeholder="0"
                           value="${cls.percentage || ''}"
                           oninput="updateTotal()"
                           ${cls.selected ? '' : 'disabled'}
                           class="w-24 px-3 py-2 border rounded-md">
                    <span>%</span>
                    ${cls.isCustom ? `<button type="button" onclick="removeCustomClass('${cls.key}')" class="text-xs text-red-600 hover:text-red-800">Remover</button>` : ''}
                </div>
            </div>
        </div>
    `).join('');
    updateTotal();
}

function toggleClass(key) {
    const cls = selectedClasses.find(c => c.key === key);
    if (!cls) return;
    const checked = document.getElementById(`class_${key}`).checked;
    const inputDiv = document.getElementById(`input_${key}`);
    const percentInput = document.getElementById(`percent_${key}`);

    cls.selected = checked;
    if (checked) {
        inputDiv.style.display = 'flex';
        percentInput.disabled = false;
    } else {
        inputDiv.style.display = 'none';
        percentInput.disabled = true;
        percentInput.value = '';
        cls.percentage = 0;
    }
    updateTotal();
}

function addCustomClass() {
    showClassesError('');
    const input = document.getElementById('custom_class_name');
    const rawName = (input.value || '').trim();
    if (!rawName) {
        showClassesError('Informe o nome da classe personalizada.');
        return;
    }

    const normalizedNew = rawName.toLowerCase();
    const alreadyExists = selectedClasses.some(c => c.name.toLowerCase() === normalizedNew);
    if (alreadyExists) {
        showClassesError('J√° existe uma classe com este nome.');
        return;
    }

    const keyBase = classKeyFromName(rawName) || 'custom';
    let key = `c_${keyBase}`;
    let seq = 1;
    while (selectedClasses.some(c => c.key === key)) {
        seq += 1;
        key = `c_${keyBase}_${seq}`;
    }

    selectedClasses.push({
        key,
        id: null,
        name: rawName,
        description: 'Classe personalizada',
        isCustom: true,
        selected: true,
        percentage: 0
    });

    input.value = '';
    renderClassesStep2();
}

function removeCustomClass(key) {
    selectedClasses = selectedClasses.filter(c => c.key !== key);
    renderClassesStep2();
}

function updateTotal() {
    let total = 0;
    selectedClasses.filter(c => c.selected).forEach(cls => {
        const value = parseFloat(document.getElementById(`percent_${cls.key}`).value) || 0;
        cls.percentage = value;
        total += value;
    });
    
    document.getElementById('total_percentage').textContent = `Total: ${total.toFixed(1)}%`;
    document.getElementById('total_percentage').className = total === 100 ? 'text-2xl font-bold mt-2 text-green-600' : 'text-2xl font-bold mt-2 text-red-600';
    
    document.getElementById('create_btn').disabled = total !== 100;
}

async function createPortfolio() {
    const portfolioData = {
        name: document.getElementById('portfolio_name').value,
        description: document.getElementById('portfolio_description').value,
        total_value: parseFloat(document.getElementById('total_value').value),
        currency: document.getElementById('currency').value
    };
    
    try {
        // 1. Cria portfolio
        const response = await fetch('/portfolios/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(portfolioData)
        });
        
        const portfolio = await response.json();
        if (!response.ok) {
            throw new Error(portfolio.detail || 'Erro ao criar portfolio');
        }

        const classesToCreate = selectedClasses.filter(c => c.selected && c.percentage > 0);
        if (classesToCreate.length === 0) {
            throw new Error('Selecione classes e defina percentuais maiores que zero.');
        }

        const uniqueNames = new Set(classesToCreate.map(c => c.name.toLowerCase()));
        if (uniqueNames.size !== classesToCreate.length) {
            throw new Error('Existem classes com nomes duplicados.');
        }
        
        // 2. Adiciona classes com percentuais
        for (const cls of classesToCreate) {
            const classResp = await fetch(`/asset-classes/?portfolio_id=${portfolio.id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: cls.name,
                    target_percentage: cls.percentage,
                    rebalance_threshold_percentage: 5.0,
                    is_custom: cls.isCustom
                })
            });

            if (!classResp.ok) {
                const classErr = await classResp.json().catch(() => ({}));
                throw new Error(classErr.detail || `Erro ao adicionar classe ${cls.name}`);
            }
        }
        
        alert('‚úÖ Portfolio criado com sucesso!');
        window.location.href = '/portfolios/list';
        
    } catch (error) {
        alert('‚ùå Erro: ' + error.message);
    }
}
</script>
{% endblock %}
