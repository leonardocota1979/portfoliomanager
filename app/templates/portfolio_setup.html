{% extends "base.html" %}

{% block nav_links %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Configurar Portfolio</h1>

    <!-- PASSO 1: Info B√°sica -->
    <div id="step1" class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4">üìã Passo 1: Informa√ß√µes B√°sicas</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Carteira *</label>
                <input type="text" id="portfolio_name" required
                       class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                       placeholder="Ex: Minha Carteira Global">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                <textarea id="portfolio_description" rows="3"
                          class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                          placeholder="Estrat√©gia e objetivos..."></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor Total *</label>
                    <input type="number" id="total_value" required step="0.01" min="0"
                           class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500"
                           placeholder="1000000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Moeda *</label>
                    <select id="currency" class="w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                        <option value="USD">USD - D√≥lar Americano</option>
                        <option value="BRL">BRL - Real Brasileiro</option>
                        <option value="EUR">EUR - Euro</option>
                    </select>
                </div>
            </div>
        </div>

        <button onclick="goToStep2()" class="mt-6 bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700">
            Pr√≥ximo: Selecionar Classes ‚Üí
        </button>
    </div>

    <!-- PASSO 2: Selecionar Classes -->
    <div id="step2" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">üéØ Passo 2: Selecionar Classes de Ativos</h2>
        
        <div id="classes_list" class="space-y-3 mb-6">
            <!-- Ser√° preenchido via JavaScript -->
        </div>

        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
            <p class="text-sm text-yellow-700">
                ‚ö†Ô∏è A soma dos percentuais deve ser <strong>100%</strong>
            </p>
            <p class="text-2xl font-bold mt-2" id="total_percentage">Total: 0%</p>
        </div>

        <div class="flex gap-4">
            <button onclick="goToStep1()" class="bg-green-50 text-green-700 border border-green-200 px-6 py-3 rounded-md hover:bg-green-100">
                ‚Üê Voltar
            </button>
            <button onclick="createPortfolio()" id="create_btn" disabled
                    class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                Criar Portfolio ‚úì
            </button>
        </div>
    </div>
</div>

<script>
let selectedClasses = [];
let globalClasses = [];

// Carrega classes globais
async function loadGlobalClasses() {
    const response = await fetch('/admin/global-classes/');
    globalClasses = await response.json();
    renderClassesStep2();
}

function goToStep2() {
    const name = document.getElementById('portfolio_name').value;
    const value = document.getElementById('total_value').value;
    
    if (!name || !value || value <= 0) {
        alert('Preencha nome e valor total!');
        return;
    }
    
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
    loadGlobalClasses();
}

function goToStep1() {
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
}

function renderClassesStep2() {
    const container = document.getElementById('classes_list');
    container.innerHTML = globalClasses.map(cls => `
        <div class="border rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="class_${cls.id}" 
                           onchange="toggleClass(${cls.id}, '${cls.name}')"
                           class="w-5 h-5">
                    <label for="class_${cls.id}" class="font-medium">${cls.name}</label>
                    <span class="text-sm text-gray-500">${cls.description}</span>
                </div>
                <div class="flex items-center gap-2" id="input_${cls.id}" style="display:none;">
                    <input type="number" id="percent_${cls.id}" 
                           min="0" max="100" step="0.1" placeholder="0"
                           oninput="updateTotal()"
                           class="w-24 px-3 py-2 border rounded-md">
                    <span>%</span>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleClass(id, name) {
    const checked = document.getElementById(`class_${id}`).checked;
    const inputDiv = document.getElementById(`input_${id}`);
    
    if (checked) {
        inputDiv.style.display = 'flex';
        selectedClasses.push({id, name, percentage: 0});
    } else {
        inputDiv.style.display = 'none';
        selectedClasses = selectedClasses.filter(c => c.id !== id);
        document.getElementById(`percent_${id}`).value = '';
    }
    updateTotal();
}

function updateTotal() {
    let total = 0;
    selectedClasses.forEach(cls => {
        const value = parseFloat(document.getElementById(`percent_${cls.id}`).value) || 0;
        cls.percentage = value;
        total += value;
    });
    
    document.getElementById('total_percentage').textContent = `Total: ${total.toFixed(1)}%`;
    document.getElementById('total_percentage').className = total === 100 ? 'text-2xl font-bold mt-2 text-green-600' : 'text-2xl font-bold mt-2 text-red-600';
    
    document.getElementById('create_btn').disabled = total !== 100;
}

async function createPortfolio() {
    const portfolioData = {
        name: document.getElementById('portfolio_name').value,
        description: document.getElementById('portfolio_description').value,
        total_value: parseFloat(document.getElementById('total_value').value),
        currency: document.getElementById('currency').value
    };
    
    try {
        // 1. Cria portfolio
        const response = await fetch('/portfolios/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(portfolioData)
        });
        
        const portfolio = await response.json();
        
        // 2. Adiciona classes com percentuais
        for (const cls of selectedClasses) {
            if (cls.percentage > 0) {
                await fetch(`/asset-classes/?portfolio_id=${portfolio.id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: cls.name,
                        target_percentage: cls.percentage,
                        rebalance_threshold_percentage: 5.0
                    })
                });
            }
        }
        
        alert('‚úÖ Portfolio criado com sucesso!');
        window.location.href = '/portfolios/list';
        
    } catch (error) {
        alert('‚ùå Erro: ' + error.message);
    }
}
</script>
{% endblock %}
