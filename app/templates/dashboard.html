<!-- app/templates/dashboard.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .collapse-content.open { max-height: 2000px; }
        .sort-icon { opacity: 0.3; transition: opacity 0.2s; }
        .sort-icon.active { opacity: 1; }
        .filter-popup { display: none; position: absolute; z-index: 50; }
        .filter-popup.show { display: block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-ok { background: #22c55e; }
        .status-updating { background: #f59e0b; animation: pulse 1s infinite; }
        .status-error { background: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .chart-container { position: relative; height: 300px; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-7xl">
        
        <!-- CABE√áALHO -->
        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
            <div>
                <a href="/portfolios/list" onclick="window.location.href='/portfolios/list'; return false;" class="text-blue-600 hover:underline mb-2 inline-block text-sm">&larr; Voltar √†s Carteiras</a>
                <h1 class="text-3xl font-bold text-gray-800">{{ portfolio_name }}</h1>
            </div>
            <div class="flex gap-2 flex-wrap">
                <!-- Status de atualiza√ß√£o -->
                <div id="priceStatus" class="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-lg text-sm">
                    <span class="status-indicator status-ok" id="statusDot"></span>
                    <span id="statusText">Atualizado</span>
                </div>
                <button onclick="updatePrices()" id="updateBtn" 
                        class="bg-white text-slate-700 border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 text-sm font-medium flex items-center gap-2 whitespace-nowrap">
                    <span id="updateIcon">üîÑ</span>
                    Atualizar Pre√ßos
                </button>
                <button onclick="openEditPortfolioModal()" 
                        class="bg-white text-slate-700 border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 text-sm font-medium whitespace-nowrap">
                    ‚öôÔ∏è Editar
                </button>
                <button onclick="openAddAssetModal()" 
                        class="bg-white text-slate-700 border border-slate-200 px-4 py-2 rounded-lg hover:bg-slate-50 text-sm font-medium whitespace-nowrap">
                    ‚ûï Adicionar Ativo
                </button>
                <select id="templateSelect" onchange="setDashboardTemplate(this.value)"
                        class="px-3 py-2 border rounded-lg text-sm bg-white">
                    <option value="v1" {% if dashboard_template == 'v1' %}selected{% endif %}>Template 1</option>
                    <option value="v2" {% if dashboard_template == 'v2' %}selected{% endif %}>Template 2</option>
                    <option value="v3" {% if dashboard_template == 'v3' %}selected{% endif %}>Template 3</option>
                </select>
            </div>
        </div>

        <!-- RESUMO DO PORTFOLIO -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div>
                    <p class="text-gray-500 text-xs uppercase">Valor Total (Definido)</p>
                    <p class="text-2xl font-bold text-blue-600">{{ currency }} {{ "{:,.2f}".format(total_portfolio_value) }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs uppercase">Valor Alocado</p>
                    <p class="text-2xl font-bold text-green-600">{{ currency }} {{ "{:,.2f}".format(total_real_value) }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs uppercase">CASH Dispon√≠vel</p>
                    <p class="text-2xl font-bold text-orange-500">{{ currency }} {{ "{:,.2f}".format(summary.total_cash) }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs uppercase">Classes</p>
                    <p class="text-2xl font-bold text-gray-700">{{ summary.total_classes }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs uppercase">Ativos</p>
                    <p class="text-2xl font-bold text-gray-700">{{ summary.total_assets }}</p>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICOS -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Gr√°fico de Pizza -->
            <div class="bg-white shadow rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3">Aloca√ß√£o por Classe</h3>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
                <div id="pieDetails" class="mt-4 p-3 bg-gray-50 rounded hidden">
                    <!-- Detalhes da fatia selecionada -->
                </div>
            </div>
            
            <!-- Gr√°fico de Barras Meta vs Real -->
            <div class="bg-white shadow rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-3">Meta vs Real por Classe</h3>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
                <!-- legenda removida (n√£o faz sentido no bullet) -->
            </div>
        </div>

        <!-- TABELA DE ATIVOS (Hier√°rquica) -->
        <div class="bg-white shadow rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Ativos por Classe</h2>
                <button onclick="toggleAllClasses()" class="text-sm text-blue-600 hover:underline">
                    Expandir/Recolher Todos
                </button>
            </div>
            
            <!-- Filtros globais -->
            <div class="mb-4 p-3 bg-gray-50 rounded flex flex-wrap gap-3 items-center text-sm">
                <span class="font-medium">Filtros:</span>
                <input type="text" id="globalSearch" placeholder="Buscar..." 
                       onkeyup="applyFilters()"
                       class="px-3 py-1 border rounded w-48">
                <select id="filterStatus" onchange="applyFilters()" class="px-3 py-1 border rounded">
                    <option value="">Todos os Status</option>
                    <option value="OK">‚úÖ OK</option>
                    <option value="Alerta">‚ö†Ô∏è Alerta</option>
                    <option value="Cr√≠tico">üö® Cr√≠tico</option>
                    <option value="Extremamente Cr√≠tico">üí• Extremamente Cr√≠tico</option>
                </select>
                <button onclick="clearFilters()" class="text-gray-500 hover:text-gray-700">‚úï Limpar</button>
            </div>

            <!-- Classes de Ativos (Expans√≠veis) -->
            {% for asset_class in asset_classes %}
            <div class="asset-class-group mb-2 border rounded" data-class-id="{{ asset_class.id }}">
                <!-- Header da Classe (Clic√°vel) -->
                <div class="asset-class-header flex justify-between items-center p-3 bg-gray-100 cursor-pointer hover:bg-gray-200"
                     onclick="toggleClass({{ asset_class.id }})">
                    <div class="flex items-center gap-3">
                        <span class="collapse-arrow text-gray-500" id="arrow-{{ asset_class.id }}">‚ñ∂</span>
                        <span class="font-semibold">{{ asset_class.name }}</span>
                        <span class="text-sm text-gray-500">({{ asset_class.assets|length }} ativos)</span>
                        <span class="text-sm {{ asset_class.deviation_color_class }}">{{ asset_class.deviation_status }}</span>
                    </div>
                    <div class="flex items-center gap-4 text-sm text-gray-600 flex-wrap">
                        <span class="flex items-center gap-1 text-teal-600">
                            üéØ Meta {{ "{:.1f}".format(asset_class.target_percentage) }}%
                        </span>
                        <span class="flex items-center gap-1 text-teal-600">
                            üí∞ Alvo {{ currency }} {{ "{:,.0f}".format(asset_class.target_value) }}
                        </span>
                        <span class="text-gray-400">|</span>
                        <span class="flex items-center gap-1 text-teal-600">
                            üìä Real {{ "{:.1f}".format(asset_class.current_percentage) }}%
                        </span>
                        <span class="flex items-center gap-1 text-teal-600">
                            üíµ {{ currency }} {{ "{:,.0f}".format(asset_class.allocated_value) }}
                        </span>
                    </div>
                </div>
                
                <!-- Tabela de Ativos da Classe (Colaps√°vel) -->
                <div class="collapse-content" id="content-{{ asset_class.id }}">
                    {% if asset_class.assets %}
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 uppercase text-xs">
                                <th class="py-2 px-3 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'name')">
                                    Ativo <span class="sort-icon" data-col="name">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'quantity')">
                                    Qtd <span class="sort-icon" data-col="quantity">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'current_price')">
                                    Cota√ß√£o <span class="sort-icon" data-col="current_price">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'current_value')">
                                    Valor <span class="sort-icon" data-col="current_value">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'current_percentage_class')">
                                    % Atual (Classe) <span class="sort-icon" data-col="current_percentage_class">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'target_percentage')">
                                    % Meta (Classe) <span class="sort-icon" data-col="target_percentage">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'deviation_percentage')">
                                    Desvio (Classe) <span class="sort-icon" data-col="deviation_percentage">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'current_percentage')">
                                    % Atual (Portf) <span class="sort-icon" data-col="current_percentage">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'target_percentage_portfolio')">
                                    % Meta (Portf) <span class="sort-icon" data-col="target_percentage_portfolio">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'deviation_percentage_portfolio')">
                                    Desvio (Portf) <span class="sort-icon" data-col="deviation_percentage_portfolio">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-center cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'status')">
                                    Status <span class="sort-icon" data-col="status">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-right cursor-pointer hover:bg-gray-100" onclick="sortTable({{ asset_class.id }}, 'units_to_buy')">
                                    Comprar/Vender <span class="sort-icon" data-col="units_to_buy">‚Üï</span>
                                </th>
                                <th class="py-2 px-3 text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="asset-tbody">
                            {% for asset in asset_class.assets %}
                            <tr class="asset-row border-t hover:bg-gray-50" 
                                data-name="{{ asset.name }}" 
                                data-ticker="{{ asset.ticker }}"
                                data-status="{{ asset.rebalance_status }}"
                                data-quantity="{{ asset.quantity }}"
                                data-price="{{ asset.current_price }}"
                                data-value="{{ asset.current_value }}"
                                data-current-pct="{{ asset.current_percentage }}"
                                data-currentpercentage="{{ asset.current_percentage }}"
                                data-target-pct="{{ asset.target_percentage }}"
                                data-targetpercentage="{{ asset.target_percentage }}"
                                data-currentpercentageclass="{{ asset.current_percentage_class }}"
                                data-targetpercentageportfolio="{{ asset.target_percentage_portfolio }}"
                                data-deviation="{{ asset.deviation_percentage }}"
                                data-deviationpercentage="{{ asset.deviation_percentage }}"
                                data-deviationpercentageportfolio="{{ asset.deviation_percentage_portfolio }}"
                                data-units_to_buy="{{ asset.units_to_buy }}"
                                data-status="{{ asset.rebalance_status }}">
                                <td class="py-2 px-3">
                                    <div class="font-semibold text-gray-900">{{ asset.ticker }}</div>
                                    <div class="text-xs text-gray-500">{{ asset.name }}</div>
                                </td>
                                <td class="py-2 px-3 text-right">{{ "{:,.4f}".format(asset.quantity).rstrip('0').rstrip('.') }}</td>
                                <td class="py-2 px-3 text-right {% if asset.current_price == 0 %}text-red-500{% endif %}">
                                    {{ currency }} {{ "{:,.2f}".format(asset.current_price) }}
                                    {% if asset.current_price == 0 %}<span class="text-xs">‚ö†Ô∏è</span>{% endif %}
                                </td>
                                <td class="py-2 px-3 text-right">{{ currency }} {{ "{:,.2f}".format(asset.current_value) }}</td>
                                <td class="py-2 px-3 text-right">{{ "{:+.2f}".format(asset.deviation_percentage) }}%</td>
                                <td class="py-2 px-3 text-right">{{ "{:.2f}".format(asset.current_percentage_class) }}%</td>
                                <td class="py-2 px-3 text-right">{{ "{:.2f}".format(asset.target_percentage) }}%</td>
                                <td class="py-2 px-3 text-right">{{ "{:+.2f}".format(asset.deviation_percentage) }}%</td>
                                <td class="py-2 px-3 text-right">{{ "{:.2f}".format(asset.current_percentage) }}%</td>
                                <td class="py-2 px-3 text-right">{{ "{:.2f}".format(asset.target_percentage_portfolio) }}%</td>
                                <td class="py-2 px-3 text-right">{{ "{:+.2f}".format(asset.deviation_percentage_portfolio) }}%</td>
                                <td class="py-2 px-3 text-center {{ asset.rebalance_color_class }} font-medium">
                                    {{ asset.rebalance_emoji }}
                                </td>
                                <td class="py-2 px-3 text-right text-xs">
                                    {% if asset.units_to_buy > 0 %}
                                    <span class="text-green-600">+{{ "{:,.2f}".format(asset.units_to_buy) }} un</span>
                                    {% elif asset.units_to_buy < 0 %}
                                    <span class="text-red-600">{{ "{:,.2f}".format(asset.units_to_buy) }} un</span>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="py-2 px-3 text-center">
                                    <button onclick="openEditAssetModal({{ asset.id }}, '{{ asset.name }}', '{{ asset.ticker }}', {{ asset.quantity }}, {{ asset.target_percentage }}, {{ asset.current_price }})"
                                            class="text-blue-600 hover:text-blue-800" title="Editar">‚úèÔ∏è</button>
                                    <button onclick="confirmDeleteAsset({{ asset.id }}, '{{ asset.ticker }}')"
                                            class="text-red-600 hover:text-red-800 ml-1" title="Remover">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-4 text-center text-gray-500 text-sm">
                        Nenhum ativo nesta classe. <button onclick="openAddAssetModal()" class="text-blue-600 hover:underline">Adicionar</button>
                    </div>
                    {% endif %}
                    
                    <!-- CASH da classe -->
                    {% if asset_class.cash_value > 0 %}
                    <div class="p-3 bg-orange-50 border-t flex justify-between items-center text-sm">
                        <span class="text-orange-700">üíµ CASH n√£o alocado nesta classe</span>
                        <span class="font-semibold text-orange-700">{{ currency }} {{ "{:,.2f}".format(asset_class.cash_value) }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            {% if not asset_classes %}
            <div class="text-center py-8 text-gray-500">
                <p>Nenhuma classe de ativos configurada.</p>
                <p class="text-sm mt-2">Configure as classes de ativos nas configura√ß√µes do portfolio.</p>
            </div>
            {% endif %}
        </div>

        <!-- Alertas (pequeno e discreto) -->
        {% if alerts %}
        <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-xs text-yellow-700">
            <span class="font-medium">‚ö†Ô∏è Avisos:</span>
            {{ alerts | join(' | ') }}
        </div>
        {% endif %}
    </div>

    <!-- RODAP√â -->
    <footer class="py-4 bg-gray-200 text-center text-gray-600 text-xs">
        <p>üìä √öltima atualiza√ß√£o: <span id="lastUpdate">{% if last_prices_updated %}{{ last_prices_updated }}{% else %}Nunca{% endif %}</span> | Auto-refresh: 1 min | Fontes: Finnhub, Brapi, CoinGecko</p>
    </footer>

    <!-- MODAIS -->
    {% include "partials/modal_edit_portfolio.html" ignore missing %}
    {% include "partials/modal_add_asset.html" ignore missing %}
    {% include "partials/modal_edit_asset.html" ignore missing %}

    <script>
    // ==== VARI√ÅVEIS GLOBAIS ====
    const portfolioId = {{ portfolio_id }};
    const currency = "{{ currency }}";
    let autoRefreshInterval = null;
    let sortState = {}; // {classId: {col: 'name', asc: true}}

    // ==== AUTO REFRESH (1 minuto) ====
    function startAutoRefresh() {
        autoRefreshInterval = setInterval(updatePrices, 60000);
        console.log('Auto-refresh iniciado (1 min)');
    }
    
    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // ==== ATUALIZA√á√ÉO DE PRE√áOS ====
    async function updatePrices() {
        const btn = document.getElementById('updateBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        btn.disabled = true;
        statusDot.className = 'status-indicator status-updating';
        statusText.textContent = 'Atualizando...';
        
        try {
            const resp = await fetch(`/dashboard/update-prices/${portfolioId}`, { method: 'POST' });
            const data = await resp.json();
            
            if (data.success) {
                document.getElementById('lastUpdate').textContent = new Date(data.updated_at).toLocaleString('pt-BR');
                statusDot.className = 'status-indicator status-ok';
                statusText.textContent = data.error_count > 0 ? `${data.updated_count}/${data.updated_count + data.error_count} OK` : 'Atualizado';
                
                // Recarrega p√°gina ap√≥s breve delay para mostrar novos dados
                setTimeout(() => window.location.reload(), 1000);
            } else {
                statusDot.className = 'status-indicator status-error';
                statusText.textContent = 'Erro';
            }
        } catch (e) {
            statusDot.className = 'status-indicator status-error';
            statusText.textContent = 'Erro';
            console.error('Erro ao atualizar pre√ßos:', e);
        } finally {
            btn.disabled = false;
        }
    }

    async function setDashboardTemplate(template) {
        try {
            await fetch(`/dashboard/template/${portfolioId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ template })
            });
            const routes = {
                v1: `/dashboard?portfolio_id=${portfolioId}`,
                v2: `/dashboard/preview?portfolio_id=${portfolioId}`,
                v3: `/dashboard/preview-v3?portfolio_id=${portfolioId}`
            };
            window.location.href = routes[template] || routes.v1;
        } catch (e) {
            alert('Erro ao trocar template');
        }
    }

    // ==== MODAIS ====
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }
    
    function openEditPortfolioModal() {
        document.getElementById('editPortfolioModal').classList.remove('hidden');
    }
    
    function openAddAssetModal() {
        document.getElementById('addAssetModal').classList.remove('hidden');
        document.getElementById('addAssetForm').reset();
    }
    
    function openEditAssetModal(id, name, ticker, qty, targetPct, price) {
        document.getElementById('edit_asset_id').value = id;
        document.getElementById('edit_asset_ticker').value = ticker;
        document.getElementById('edit_asset_ticker_display').textContent = ticker;
        document.getElementById('edit_asset_quantity').value = qty;
        document.getElementById('edit_asset_target_pct').value = targetPct;
        document.getElementById('edit_asset_price').value = price > 0 ? price : '';
        document.getElementById('editAssetModal').classList.remove('hidden');
    }

    // ==== COLLAPSE/EXPAND CLASSES ====
    function toggleClass(classId) {
        const content = document.getElementById(`content-${classId}`);
        const arrow = document.getElementById(`arrow-${classId}`);
        
        if (content.classList.contains('open')) {
            content.classList.remove('open');
            arrow.textContent = '‚ñ∂';
        } else {
            content.classList.add('open');
            arrow.textContent = '‚ñº';
        }
    }
    
    function toggleAllClasses() {
        const contents = document.querySelectorAll('.collapse-content');
        const allOpen = Array.from(contents).every(c => c.classList.contains('open'));
        
        contents.forEach(content => {
            const classId = content.id.replace('content-', '');
            const arrow = document.getElementById(`arrow-${classId}`);
            
            if (allOpen) {
                content.classList.remove('open');
                if (arrow) arrow.textContent = '‚ñ∂';
            } else {
                content.classList.add('open');
                if (arrow) arrow.textContent = '‚ñº';
            }
        });
    }

    // ==== ORDENA√á√ÉO ====
    function sortTable(classId, column) {
        const tbody = document.querySelector(`#content-${classId} .asset-tbody`);
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('.asset-row'));
        
        // Toggle dire√ß√£o
        if (!sortState[classId]) sortState[classId] = {};
        const asc = sortState[classId].col === column ? !sortState[classId].asc : true;
        sortState[classId] = { col: column, asc };
        
        rows.sort((a, b) => {
            let valA = a.dataset[column.replace(/_/g, '')] || a.dataset[column];
            let valB = b.dataset[column.replace(/_/g, '')] || b.dataset[column];
            
            // Tenta converter para n√∫mero
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            
            if (!isNaN(numA) && !isNaN(numB)) {
                return asc ? numA - numB : numB - numA;
            }
            
            // Ordena√ß√£o string
            valA = (valA || '').toLowerCase();
            valB = (valB || '').toLowerCase();
            return asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        });
        
        // Re-insere na ordem
        rows.forEach(row => tbody.appendChild(row));
    }

    // ==== FILTROS ====
    function applyFilters() {
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const statusFilter = document.getElementById('filterStatus').value;
        
        document.querySelectorAll('.asset-row').forEach(row => {
            const name = (row.dataset.name || '').toLowerCase();
            const ticker = (row.dataset.ticker || '').toLowerCase();
            const status = row.dataset.status || '';
            
            const matchSearch = !search || name.includes(search) || ticker.includes(search);
            const matchStatus = !statusFilter || status === statusFilter;
            
            row.style.display = matchSearch && matchStatus ? '' : 'none';
        });
    }
    
    function clearFilters() {
        document.getElementById('globalSearch').value = '';
        document.getElementById('filterStatus').value = '';
        applyFilters();
    }

    // ==== FORMS ====
    function parseNumber(val) {
        if (!val) return 0;
        return parseFloat(String(val).trim().replace(/,/g, '.')) || 0;
    }

    async function autoFillQuantityIfEmpty() {
        const qtyEl = document.getElementById('add_quantity');
        const targetPctEl = document.getElementById('add_target_pct');
        const classIdEl = document.getElementById('add_class');
        const tickerEl = document.getElementById('add_ticker');

        const qty = parseNumber(qtyEl.value);
        const targetPct = parseNumber(targetPctEl.value);
        const classId = parseInt(classIdEl.value);
        const ticker = (tickerEl.value || '').trim().toUpperCase();

        if (qty > 0) return; // usu√°rio j√° informou
        if (!ticker || !classId || targetPct <= 0) return;

        try {
            const resp = await fetch('/assets/suggest-quantity', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    portfolio_id: portfolioId,
                    asset_class_id: classId,
                    ticker,
                    target_pct_class: targetPct
                })
            });
            if (!resp.ok) return;
            const data = await resp.json();
            if (data.quantity && data.quantity > 0) {
                qtyEl.value = data.quantity.toFixed(4);
            }
        } catch (e) {
            console.warn('autoFillQuantity error', e);
        }
    }
    
    document.getElementById('editPortfolioForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('edit_portfolio_name').value.trim();
        const value = parseNumber(document.getElementById('edit_portfolio_value').value);
        const curr = document.getElementById('edit_portfolio_currency').value;
        
        try {
            const resp = await fetch(`/portfolios/${portfolioId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, total_value: value, currency: curr, description: '' })
            });
            if (!resp.ok) throw new Error((await resp.json()).detail);
            window.location.reload();
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    });
    
    document.getElementById('addAssetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const ticker = document.getElementById('add_ticker').value.trim().toUpperCase();
        const name = document.getElementById('add_name').value.trim() || ticker;
        const classId = parseInt(document.getElementById('add_class').value);
        let qty = parseNumber(document.getElementById('add_quantity').value);
        const targetPct = parseNumber(document.getElementById('add_target_pct').value);
        
        if (!ticker || !classId || targetPct <= 0) {
            alert('Preencha todos os campos corretamente');
            return;
        }

        if (!qty || qty <= 0) {
            await autoFillQuantityIfEmpty();
            qty = parseNumber(document.getElementById('add_quantity').value);
        }
        if (!qty || qty <= 0) {
            alert('N√£o foi poss√≠vel calcular a quantidade. Informe manualmente.');
            return;
        }
        
        try {
            // 1. Valida ticker
            const valResp = await fetch(`/search/validate/${ticker}`);
            const valData = await valResp.json();
            if (!valData.valid) {
                alert('Ticker inv√°lido: ' + valData.error);
                return;
            }
            
            // 2. Busca ou cria asset
            let assetId;
            const existResp = await fetch(`/assets/ticker/${ticker}?asset_class_id=${classId}`);
            if (existResp.ok) {
                assetId = (await existResp.json()).id;
            } else {
                const createResp = await fetch('/assets/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, ticker, source: 'manual', asset_class_id: classId })
                });
                if (!createResp.ok) throw new Error((await createResp.json()).detail);
                assetId = (await createResp.json()).id;
            }
            
            // 3. Adiciona ao portfolio
            const paResp = await fetch(`/portfolio-assets/?portfolio_id=${portfolioId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ asset_id: assetId, quantity: qty, target_percentage: targetPct, rebalance_threshold_percentage: 5.0 })
            });
            if (!paResp.ok) throw new Error((await paResp.json()).detail);
            
            window.location.reload();
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    });

    // Auto preenchimento quando o usu√°rio muda ticker/classe/%meta
    document.getElementById('add_ticker').addEventListener('blur', autoFillQuantityIfEmpty);
    document.getElementById('add_class').addEventListener('change', autoFillQuantityIfEmpty);
    document.getElementById('add_target_pct').addEventListener('blur', autoFillQuantityIfEmpty);
    
    document.getElementById('editAssetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit_asset_id').value;
        const ticker = document.getElementById('edit_asset_ticker').value;
        const qty = parseNumber(document.getElementById('edit_asset_quantity').value);
        const targetPct = parseNumber(document.getElementById('edit_asset_target_pct').value);
        const price = parseNumber(document.getElementById('edit_asset_price').value);
        
        try {
            const resp = await fetch(`/portfolio-assets/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ quantity: qty, target_percentage: targetPct })
            });
            if (!resp.ok) throw new Error((await resp.json()).detail);
            
            if (price > 0) {
                await fetch(`/assets/update-price/${ticker}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ price })
                });
            }
            
            window.location.reload();
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    });
    
    async function confirmDeleteAsset(id, ticker) {
        if (!confirm(`Remover ${ticker} da carteira?`)) return;
        try {
            await fetch(`/portfolio-assets/${id}`, { method: 'DELETE' });
            window.location.reload();
        } catch (e) {
            alert('Erro: ' + e.message);
        }
    }

    // ==== GR√ÅFICOS ====
    const chartColors = [
        '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
        '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
    ];
    
    function initCharts() {
        // Dados das classes
        const classesData = {{ asset_classes | tojson | safe }};
        
        // Gr√°fico de Pizza
        const pieCtx = document.getElementById('pieChart');
        if (pieCtx && classesData.length > 0) {
            new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: classesData.map(c => c.name),
                    datasets: [{
                        data: classesData.map(c => c.target_value),
                        backgroundColor: chartColors.slice(0, classesData.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } },
                        datalabels: {
                            color: '#111827',
                            font: { size: 10, weight: '600' },
                            formatter: (value, ctx) => {
                                const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                                const pct = total > 0 ? (value / total) * 100 : 0;
                                const label = ctx.chart.data.labels[ctx.dataIndex];
                                return `${label}\n${pct.toFixed(1)}%`;
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const c = classesData[ctx.dataIndex];
                                    return `${c.name}: ${currency} ${c.target_value.toLocaleString()} (${c.target_percentage}%)`;
                                }
                            }
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            showPieDetails(classesData[idx]);
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        // Gr√°fico de Bullet (Meta vs Real)
        const barCtx = document.getElementById('barChart');
        if (barCtx && classesData.length > 0) {
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: classesData.map(c => c.name),
                    datasets: [
                        {
                            label: 'Real %',
                            data: classesData.map(c => c.current_percentage),
                            backgroundColor: chartColors.slice(0, classesData.length),
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#0f172a',
                            font: { size: 10, weight: '600' },
                            anchor: 'end',
                            align: 'right',
                            formatter: (value) => `${value.toFixed(1)}%`
                        },
                        annotation: {
                            annotations: classesData.map((c, i) => ({
                                type: 'line',
                                xMin: c.target_percentage,
                                xMax: c.target_percentage,
                                yMin: i - 0.4,
                                yMax: i + 0.4,
                                borderColor: '#0f172a',
                                borderWidth: 2
                            }))
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: '%' } },
                        y: { ticks: { font: { size: 11 } } }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
    }
    
    function showPieDetails(classData) {
        const details = document.getElementById('pieDetails');
        details.innerHTML = `
            <h4 class="font-semibold mb-2">${classData.name}</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div>Meta: ${classData.target_percentage}%</div>
                <div>Real: ${classData.current_percentage.toFixed(1)}%</div>
                <div>Valor Alvo: ${currency} ${classData.target_value.toLocaleString()}</div>
                <div>Alocado: ${currency} ${classData.allocated_value.toLocaleString()}</div>
                <div class="col-span-2 text-orange-600">CASH: ${currency} ${classData.cash_value.toLocaleString()}</div>
            </div>
            <div class="mt-2 text-xs text-gray-500">Ativos: ${classData.assets.length}</div>
        `;
        details.classList.remove('hidden');
    }

    // ==== INICIALIZA√á√ÉO ====
    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        startAutoRefresh();
        
        // Expande todas as classes por padr√£o
        const contents = document.querySelectorAll('.collapse-content');
        contents.forEach(content => {
            content.classList.add('open');
            const classId = content.id.replace('content-', '');
            const arrow = document.getElementById(`arrow-${classId}`);
            if (arrow) arrow.textContent = '‚ñº';
        });
    });
    
    // ESC fecha modais
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            ['editPortfolioModal', 'addAssetModal', 'editAssetModal'].forEach(closeModal);
        }
    });
    </script>
</body>
</html>
