{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-6">
        <a href="/portfolios/list" class="text-blue-600 hover:text-blue-800">&larr; Voltar para Minhas Carteiras</a>
    </div>

    <h1 class="text-3xl font-bold text-gray-800 mb-6">Criar Nova Carteira</h1>

    <div class="bg-white p-8 rounded-lg shadow-md">
        <form id="createPortfolioForm" class="space-y-6">
            <!-- Nome da Carteira -->
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                    Nome da Carteira *
                </label>
                <input 
                    type="text" 
                    id="name" 
                    name="name" 
                    required 
                    maxlength="100"
                    placeholder="Ex: Carteira de A√ß√µes Brasileiras"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                <p class="mt-1 text-sm text-gray-500">Escolha um nome descritivo para sua carteira</p>
            </div>

            <!-- Descri√ß√£o (Opcional) -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    Descri√ß√£o (opcional)
                </label>
                <textarea 
                    id="description" 
                    name="description" 
                    rows="4"
                    maxlength="500"
                    placeholder="Ex: Carteira focada em a√ß√µes de dividendos com empresas de grande capitaliza√ß√£o..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                ></textarea>
                <p class="mt-1 text-sm text-gray-500">Adicione detalhes sobre a estrat√©gia e objetivos desta carteira</p>
            </div>

            <!-- Mensagens de erro/sucesso -->
            <div id="messageContainer" class="hidden">
                <div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative hidden" role="alert">
                    <strong class="font-bold">Erro!</strong>
                    <span class="block sm:inline" id="errorText"></span>
                </div>
                <div id="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative hidden" role="alert">
                    <strong class="font-bold">Sucesso!</strong>
                    <span class="block sm:inline">Carteira criada com sucesso!</span>
                </div>
            </div>

            <!-- Bot√µes -->
            <div class="flex gap-4">
                <button 
                    type="submit" 
                    id="submitButton"
                    class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 transition duration-300 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                >
                    <span id="submitText">Criar Carteira</span>
                    <span id="submitLoader" class="hidden">Criando...</span>
                </button>
                <a 
                    href="/portfolios/list" 
                    class="flex-1 bg-gray-300 text-gray-700 py-3 px-6 rounded-md hover:bg-gray-400 transition duration-300 font-medium text-center"
                >
                    Cancelar
                </a>
            </div>
        </form>
    </div>

    <!-- Informa√ß√µes Adicionais -->
    <div class="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
        <h3 class="text-lg font-semibold text-blue-800 mb-2">üí° Pr√≥ximos Passos</h3>
        <ul class="list-disc list-inside text-blue-700 space-y-1">
            <li>Ap√≥s criar a carteira, voc√™ poder√° adicionar classes de ativos</li>
            <li>Defina metas de aloca√ß√£o para cada classe</li>
            <li>Adicione ativos espec√≠ficos e suas quantidades</li>
            <li>Configure alertas de rebalanceamento</li>
        </ul>
    </div>
</div>

<script>
document.getElementById('createPortfolioForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitButton = document.getElementById('submitButton');
    const submitText = document.getElementById('submitText');
    const submitLoader = document.getElementById('submitLoader');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const messageContainer = document.getElementById('messageContainer');
    
    // Desabilita bot√£o e mostra loader
    submitButton.disabled = true;
    submitText.classList.add('hidden');
    submitLoader.classList.remove('hidden');
    
    // Esconde mensagens anteriores
    errorMessage.classList.add('hidden');
    successMessage.classList.add('hidden');
    messageContainer.classList.add('hidden');
    
    // Coleta dados do formul√°rio
    const formData = {
        name: document.getElementById('name').value.trim(),
        description: document.getElementById('description').value.trim() || null
    };
    
    try {
        const response = await fetch('/portfolios/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Sucesso - mostra mensagem e redireciona
            messageContainer.classList.remove('hidden');
            successMessage.classList.remove('hidden');
            
            // Redireciona ap√≥s 1.5 segundos
            setTimeout(() => {
                window.location.href = '/portfolios/list';
            }, 1500);
        } else {
            // Erro - mostra mensagem
            messageContainer.classList.remove('hidden');
            errorMessage.classList.remove('hidden');
            document.getElementById('errorText').textContent = data.detail || 'Erro ao criar carteira. Tente novamente.';
            
            // Re-habilita bot√£o
            submitButton.disabled = false;
            submitText.classList.remove('hidden');
            submitLoader.classList.add('hidden');
        }
    } catch (error) {
        // Erro de rede
        messageContainer.classList.remove('hidden');
        errorMessage.classList.remove('hidden');
        document.getElementById('errorText').textContent = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
        
        // Re-habilita bot√£o
        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        submitLoader.classList.add('hidden');
    }
});

// Valida√ß√£o em tempo real do nome
document.getElementById('name').addEventListener('input', (e) => {
    const value = e.target.value;
    if (value.length > 100) {
        e.target.value = value.substring(0, 100);
    }
});

// Valida√ß√£o em tempo real da descri√ß√£o
document.getElementById('description').addEventListener('input', (e) => {
    const value = e.target.value;
    if (value.length > 500) {
        e.target.value = value.substring(0, 500);
    }
});
</script>
{% endblock %}
